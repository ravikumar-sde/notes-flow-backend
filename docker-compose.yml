version: '3'

services:
  db:
    image: postgres:16
    container_name: notesflow_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: notesflow
      POSTGRES_PASSWORD: notesflow
      POSTGRES_DB: notesflow
    ports:
      - "5432:5432"  # host:container
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db/auth-service.sql:/docker-entrypoint-initdb.d/01-auth-service.sql:ro
      - ./db/workspace-service.sql:/docker-entrypoint-initdb.d/02-workspace-service.sql:ro

  redis:
    image: redis:7
    container_name: notesflow_redis
    command: ["redis-server", "--appendonly", "yes"]
    restart: unless-stopped
    ports:
      - "6390:6379"
    volumes:
      - redis-data:/data

  nats:
    image: nats:2
    container_name: notesflow_nats
    restart: unless-stopped
    ports:
      - "4222:4222"  # client connections
      - "8222:8222"  # monitoring

  auth-service:
    build: ./services/auth-service
    container_name: notesflow_auth_service
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4001
      DATABASE_URL: postgres://notesflow:notesflow@db:5432/notesflow
      REDIS_URL: redis://redis:6379/0
      NATS_URL: nats://nats:4222
      JWT_SECRET: dev_jwt_secret_change_me
    depends_on:
      - db
      - redis
      - nats
    ports:
      - "4001:4001"

  workspace-service:
    build: ./services/workspace-service
    container_name: notesflow_workspace_service
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4002
      DATABASE_URL: postgres://notesflow:notesflow@db:5432/notesflow
      REDIS_URL: redis://redis:6379/0
      NATS_URL: nats://nats:4222
      WORKSPACE_CACHE_TTL_SECONDS: 600
    depends_on:
      - db
      - redis
      - nats
    ports:
      - "4002:4002"

  api-gateway:
    build: ./services/api-gateway
    container_name: notesflow_api_gateway
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      AUTH_SERVICE_URL: http://auth-service:4001
      WORKSPACE_SERVICE_URL: http://workspace-service:4002
      JWT_SECRET: dev_jwt_secret_change_me
      CORS_ORIGIN: "*"
    depends_on:
      - auth-service
      - workspace-service
    ports:
      - "4000:4000"

volumes:
  db-data:
  redis-data:

